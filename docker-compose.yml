version: '3.8'

services:
  # ClickHouse Database
  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      CLICKHOUSE_DB: traces
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tracing-network

  # Trace Collector
  collector:
    build:
      context: ./collector
      dockerfile: Dockerfile
    container_name: collector
    ports:
      - "8011:8001"  # Changed from 8001:8001 to avoid conflict
      - "4318:4318"  # OTLP HTTP
    environment:
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=traces
      - PYTHONUNBUFFERED=1
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tracing-network

  # Backend API Gateway
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    ports:
      - "8002:8002"
    environment:
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_DB=traces
      - PYTHONUNBUFFERED=1
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tracing-network

  # Auth Microservice
  auth-service:
    build:
      context: ./microservices
      dockerfile: Dockerfile
    container_name: tracing_auth
    ports:
      - "8003:8003"
    environment:
      - SERVICE_NAME=auth-service
      - SERVICE_PORT=8003
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:4318
      - PYTHONUNBUFFERED=1
    command: ["python", "auth_service.py"]
    depends_on:
      collector:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tracing-network

  # Order Microservice
  order-service:
    build:
      context: ./microservices
      dockerfile: Dockerfile
    container_name: tracing_order
    ports:
      - "8004:8004"
    environment:
      - SERVICE_NAME=order-service
      - SERVICE_PORT=8004
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:4318
      - AUTH_SERVICE_URL=http://auth-service:8003
      - PAYMENT_SERVICE_URL=http://payment-service:8005
      - INVENTORY_SERVICE_URL=http://inventory-service:8006
      - PYTHONUNBUFFERED=1
    command: ["python", "order_service.py"]
    depends_on:
      - auth-service
      - payment-service
      - inventory-service
      - collector
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tracing-network

  # Payment Microservice
  payment-service:
    build:
      context: ./microservices
      dockerfile: Dockerfile
    container_name: tracing_payment
    ports:
      - "8005:8005"
    environment:
      - SERVICE_NAME=payment-service
      - SERVICE_PORT=8005
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:4318
      - PYTHONUNBUFFERED=1
    command: ["python", "payment_service.py"]
    depends_on:
      collector:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tracing-network

  # Inventory Microservice
  inventory-service:
    build:
      context: ./microservices
      dockerfile: Dockerfile
    container_name: tracing_inventory
    ports:
      - "8006:8006"
    environment:
      - SERVICE_NAME=inventory-service
      - SERVICE_PORT=8006
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:4318
      - PYTHONUNBUFFERED=1
    command: ["python", "inventory_service.py"]
    depends_on:
      collector:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tracing-network

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: tracing_frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8002
    depends_on:
      - backend
    networks:
      - tracing-network

networks:
  tracing-network:
    driver: bridge

volumes:
  clickhouse_data: