version: '3.8'

services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - CLICKHOUSE_DB=traces
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  collector:
    build: ./collector
    ports:
      - "8001:8001"
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      - CLICKHOUSE_HOST=clickhouse

  backend:
    build: ./backend
    ports:
      - "8002:8002"
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      - CLICKHOUSE_HOST=clickhouse

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend
    environment:
      - NEXT_PUBLIC_BACKEND_URL=http://backend:8002

  auth-service:
    build:
      context: ./microservices
      dockerfile: Dockerfile
    ports:
      - "8003:8003"
    environment:
      - SERVICE_PORT=8003
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:8001/v1/traces
      - OTEL_SERVICE_NAME=auth-service
      - OTEL_RESOURCE_ATTRIBUTES=service.version=1.0.0,deployment.environment=production
    depends_on:
      - collector

  order-service:
    build:
      context: ./microservices
      dockerfile: Dockerfile
    ports:
      - "8004:8004"
    environment:
      - SERVICE_PORT=8004
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:8001/v1/traces
      - OTEL_SERVICE_NAME=order-service
      - OTEL_RESOURCE_ATTRIBUTES=service.version=1.0.0,deployment.environment=production
      - AUTH_SERVICE_URL=http://auth-service:8003
      - INVENTORY_SERVICE_URL=http://inventory-service:8006
      - PAYMENT_SERVICE_URL=http://payment-service:8005
    depends_on:
      - collector
      - auth-service
      - inventory-service
      - payment-service

  payment-service:
    build:
      context: ./microservices
      dockerfile: Dockerfile
    ports:
      - "8005:8005"
    environment:
      - SERVICE_PORT=8005
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:8001/v1/traces
      - OTEL_SERVICE_NAME=payment-service
      - OTEL_RESOURCE_ATTRIBUTES=service.version=1.0.0,deployment.environment=production
    depends_on:
      - collector

  inventory-service:
    build:
      context: ./microservices
      dockerfile: Dockerfile
    ports:
      - "8006:8006"
    environment:
      - SERVICE_PORT=8006
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://collector:8001/v1/traces
      - OTEL_SERVICE_NAME=inventory-service
      - OTEL_RESOURCE_ATTRIBUTES=service.version=1.0.0,deployment.environment=production
    depends_on:
      - collector
